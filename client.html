<!doctype html>
<html>
  <head>
	<title>DieWithMe for Web[Chat] - NaN%</title>
	<meta http-equiv="charset" content="utf-8" />
	<link rel="stylesheet" href="./css/sheet.css" type="text/css" />
  </head>
  <body>
	<main id="messages"></main>
	<br><br>
	<footer><form>
	  <input id="msgin" autocomplete="off" autofocus /><input type="submit" id="sendbtn" value="发送"/>
	</form></footer>
<script src="./js/socket.io.js"></script>
<script src="./js/jquery.js"></script>
<script>
function getQuery(name){
	var reg = new RegExp("(^|&)"+name+"=([^&]*)(&|$)");
	var r = window.location.search.substr(1).match(reg);
	if(r!=null)return  unescape(r[2]); return null;
};
$(function () {
	if(!getQuery('username')||!getQuery('uid'))history.go(-1);
	var lastmid;
	var socket = io('https://api.diewithme.online');
	addEventListener('offline',function(){socket.disconnect()});
	addEventListener('online',function(){socket.connect()});
	function addmsg(json){if(json.length>1)$('#messages').text('');
		for(i=0;i<json.length;i++){
			lastmid = (json[i]._id?json[i]._id:lastmid);
			msgblock = $('<div class="msgblock-'+json[i].uid+'" id="'+json[i]._id+'">')
			msgp = $('<p class="msgp">').text(json[i].bl+'%');
			msgp.append($('<a class="message">').text(json[i].message));
			msgblock.append(msgp);
			var t = new Date(json[i].time*1000);
			var st = t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()+" "+t.getHours()+":"+t.getMinutes();
			msgblock.append($('<p class="ndp">').text(json[i].user+" @ "+st));
			$('#messages').append(msgblock);
			$(document).scrollTop($(document).height()-$(window).height()); 
		}
		
	}
	$('form').submit(function(){if(!$('#msgin').val()||!navigator.onLine||($('#msgin').val().length>100))return false;
		var json = {"chargin":"false","bl":"4"};
		json.message = $('#msgin').val();
		json.user = getQuery('username');
		json.time = Date.parse(new Date()).toString().substr(0,10);
		json.uid = getQuery('uid');
		socket.emit('new_message', json);
		addmsg([json]);
		$('#msgin').val('');
		return false;
	});
	if(!navigator.onLine)socket.disconnect();
	socket.on('getUserConnect', function(msg){
		socket.emit('userValidation',{"uid":getQuery('uid')});
		socket.emit('chooseNickname',{"username":getQuery('username')});
		socket.emit('get_messages',{});
	})
	socket.on('set_message', addmsg);
	socket.on('set_messages', addmsg);
	socket.on('validation_answer',function(msg){console.log('answer'+JSON.stringify(msg))});
	socket.on('validation_username',function(msg){console.log('username'+JSON.stringify(msg))});
	socket.on('get_nickname', function(msg){console.log('get_nickname'+msg)
	  if(msg=="false"){socket.disconnect();history.go(-1);}
	});
	$(window).resize(function(){
		$('footer').css({
			top : $(window).height()-$('footer').height()
		});
	});
	$('footer').css({top : $(window).height()-$('footer').height()});
});
 /*emit
 new_message
 get_messages
 chooseNickname
 userValidation
 send_report_user
 **on
 set_messages
 set_message
 validation_answer
 get_nickname
 */
</script>
</body>
</html>